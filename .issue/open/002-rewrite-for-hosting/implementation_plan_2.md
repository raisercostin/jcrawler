# Goal: Verify `.jcrawler1` and Diagnose Rewrite Failures

The goal is to identify why some links in the rewritten output (`.jcrawler1`) are still absolute URLs pointing to the live site, instead of being relative local links. We will assume the data in `.jcrawler1` was already generated by the user.

## User Review Required
> [!NOTE]
> I will run the verification on the existing `.jcrawler1` folder. I assume this folder exists and contains the output of the previous crawl command mentioned by the user.

## Proposed Changes

### Testing
#### [MODIFY] [AnalysisTest.java](file:///d:/home/raiser/work/namek-jcrawl/src/test/java/org/raisercostin/jcrawler/AnalysisTest.java)
- Update `htmlFiles` provider to read the root path from a system property `test.root`, defaulting to `.local-view-test`.
- This allows running the test against any directory, specifically `.jcrawler1`.

### JCrawler.java

#### [MODIFY] [JCrawler.java](file:///d:/home/raiser/work/namek-jcrawl/src/main/java/org/raisercostin/jcrawler/JCrawler.java)
- **Trim URLs during extraction**: Ensure extracted URLs are trimmed before any checks (data URI, template variables) or processing.
- **Robust Protocol Filtering**: Move `UNSUPPORTED_PROTOCOLS` check in `accept2` to the top to correctly reject `data:`, `tel:`, etc., even if they are marked as resources.
- **Data URI Protection**: Add filtering for `data:` (and potentially corrupted variants like `data\uF03A`) in `extractLinksFromContent`.

## Verification Plan

### Automated Tests
1.  **Reproduction Test**: Add a case in `RewriterTest` with a double-encoded metadata URL and a single-encoded HTML link.
2.  **AnalysisTest**:
    ```bash
    jbang -Dtest.root=.jcrawler1 src/test/java/org/raisercostin/jcrawler/AnalysisTest.java
    ```
    Should pass or show significantly fewer errors.

### Manual Verification
- None required if the automated test provides clear diagnostics.
